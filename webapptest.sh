#!/bin/bash
echo "Starting test "$1" against "$2
cp -R ./TEMPLATE ./$1
echo "Directory created"
cd ./$1/tool-output/Nmap

sudo nmap -v -sS -sU -T5 -F --version-light -oA $1'-nmap-light' $2
sudo nmap -v -sU -sV -F -T5 --version-intensity 0 -oA $1'-nmap-UDP-Fast' $2
#sudo nmap -v -sC -sV -oA -p- -Pn --host-timeout 1m -oA $1'-nmap-full' $2
#sudo nmap -v -sUV -p- -A -T5 -oA $1'-nmap-UDP' $2
echo "NMAP Scans Completed"
echo "Extracting Findings"
cat $1*.gnmap | grep '21/open/tcp//ftp' | awk '{print $2 "," "\t \t"$3 "\t \t"",FTP"}' > $1'-ftp.txt'
cat $1*.gnmap | grep '80/open/tcp//http' | awk '{print $2 "," "\t \t"$3 "\t \t"",HTTP"}' > $1'-http.txt'
cat $1*.gnmap | grep '443/open/tcp//http' | awk '{print $2 "," "\t \t"$3 "\t \t"",HTTPS"}' > $1'-https.txt'
cat $1*.gnmap | grep '53/open/udp//domain' | awk '{print $2 "," "\t \t"$3 "\t \t"",DOMAIN"}' > $1'-domain.txt'
cat $1*.gnmap | grep '53/open/tcp//domain' | awk '{print $2 "," "\t \t"$3 "\t \t"",DOMAIN"}' > $1'-domain.txt'
cat $1*.gnmap | grep '161/open/udp//snmp' | awk '{print $2 "," "\t \t"$3 "\t \t"",SNMP"}' > $1'-snmp.txt'
cat $1*.gnmap | grep '22/open/tcp//ssh' | awk '{print $2 "," "\t \t"$3 "\t \t"",SSH"}' > $1'-ssh.txt'
cat $1*.gnmap | grep '8080/open/tcp//http-proxy/' | awk '{print $2 "," "\t \t"$3 "\t \t"",HTTP"}' > $1'-proxy.txt'
cat $1*.gnmap | grep '3389/open/tcp//ms-wbt-server/' | awk '{print $2 "," "\t \t"$3 "\t \t"",RDP"}' > $1'-rdp.txt'
cat $1*.gnmap | grep '5900/open/tcp//vnc' | awk '{print $2 "," "\t \t"$3 "\t \t"",VNC"}' > $1'-vnc.txt'
cat $1*.gnmap | grep '25/open/tcp//smtp' | awk '{print $2 "," "\t \t"$3 "\t \t"",SMTP"}' > $1'-smtp.txt'
cat $1*.gnmap | grep '23/open/tcp//telnet' | awk '{print $2 "," "\t \t"$3 "\t \t"",TELNET"}' > $1'-telnet.txt'
cat $1*.gnmap | grep '1723/open/tcp//pptp' | awk '{print $2 "," "\t \t"$3 "\t \t"",PPTP"}' > $1'-pptp.txt'
cat $1*.gnmap | grep '110/open/tcp//pop3' | awk '{print $2 "," "\t \t"$3 "\t \t"",POP"}' > $1'-pop.txt'
cat $1*.gnmap | grep '143/open/tcp//imap' | awk '{print $2 "," "\t \t"$3 "\t \t"",IMAP"}' > $1'-imap.txt'
cat $1*.gnmap | grep '1433/open/tcp//ms-sql-s/' | awk '{print $2 "," "\t \t"$3 "\t \t"",SQL"}' > $1'-sql.txt'
cat $1*.gnmap | grep '8000/open/tcp//http-alt' | awk '{print $2 "," "\t \t"$3 "\t \t"",HTTP"}' > $1'-http-alt.txt'
cat $1*.gnmap | grep '445/open/tcp//microsoft-ds' | awk '{print $2 "," "\t \t"$3 "\t \t"",SMB"}' > $1'-smb.txt'
cat $1*.gnmap | grep '1521/open/tcp/' | awk '{print $2 "," "\t \t"$3 "\t \t"",ORACLE"}' > $1'-oracle.txt'
cat $1*.gnmap | grep '139/open/tcp//netbios-ssn' | awk '{print $2 "," "\t \t"$3 "\t \t"",SMB"}' > $1'-netbios.txt'
cat $1*.gnmap | grep '513/open/tcp/' | awk '{print $2 "," "\t \t"$3 "\t \t"",Rlogin"}' > $1'-rlogin.txt'
cat $1*.gnmap | grep '514/open/tcp/' | awk '{print $2 "," "\t \t"$3 "\t \t"",RSH RCP"}' > $1'-rsh.txt'
cat $1*.gnmap | awk '{print $2}' > $1'-iplist.text'

echo 'IP, Domain Name, Service' >$1'-merged.csv'
cat *.txt >> $1'-merged.csv'
echo "NMAP Output saved"
cd ..
echo "Starting Nikto Scan"
nikto -C all -output $1'-nikto.html' -host 'https://'$2
echo "Nikto Scan Compete"
echo "Starting SSL Tests"
/opt/testssl.sh/testssl.sh 'https://'$2 |aha > $1'-testssl.html'
echo "SSL Scans Complete"
cd ../..
echo 'Findings can be found in ' $1'\tool-output\'
sudo chown -R ${USER:=$(/usr/bin/id -run)}:$USER $1"/"
